name: Django CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. 코드 스타일 검사 (Linting)
  linting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
      - name: Run Flake8
        # E501: 줄 길이 제한 무시 (설정 필요에 따라 조정)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,migrations

  # 2. 코드 포맷 검사 (Formatting)
  formatting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Black
        run: pip install black
      - name: Check Formatting with Black
        run: black . --check --exclude=venv/

  # 3. 임포트 순서 검사 (Import Sorting)
  import-sorting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install isort
        run: pip install isort
      - name: Check Import Sorting
        run: isort . --check-only --profile black --skip venv/

  # 4. 보안 취약점 검사 (Security)
  security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Safety
        run: pip install safety
      - name: Run Security Check
        # requirements.txt에 있는 패키지들의 보안 취약점을 검사
        run: safety check -r requirements.txt --continue-on-error

  # 5. 도커 통합 빌드 테스트 (Integration Test)
  docker-build-test:
    runs-on: ubuntu-latest
    needs: [linting, formatting, security-check] # 위 검사들이 통과해야 실행
    steps:
      - uses: actions/checkout@v3

      # .env.prod 파일 가상 생성 (빌드 테스트용)
      - name: Create .env.prod for test
        run: |
          echo "DEBUG=False" >> .env.prod
          echo "SECRET_KEY=test_secret_key" >> .env.prod
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env.prod
          echo "POSTGRES_DB=test_db" >> .env.prod
          echo "POSTGRES_USER=test_user" >> .env.prod
          echo "POSTGRES_PASSWORD=test_pw" >> .env.prod
          echo "POSTGRES_HOST=db" >> .env.prod
          echo "POSTGRES_PORT=5432" >> .env.prod
          echo "DJANGO_EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend" >> .env.prod

      - name: Build Docker Compose
        # [수정됨] docker-compose -> docker compose
        run: docker compose config && docker compose build

      - name: Run Containers
        # [수정됨] docker-compose -> docker compose
        run: docker compose up -d

      - name: Check Container Status
        run: |
          sleep 10
          # [수정됨] docker-compose -> docker compose (아래 3곳 모두 변경)
          docker compose ps

          # 컨테이너가 죽지 않고 살아있는지 확인
          if [ $(docker compose ps --format json | jq 'length') -ge 3 ] || [ $(docker compose ps | grep "Up" | wc -l) -ge 3 ]; then
            echo "All 3 containers are running!"
          else
            echo "Some containers failed to start."
            docker compose logs
            exit 1
          fi
