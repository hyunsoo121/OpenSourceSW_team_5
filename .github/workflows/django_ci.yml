name: Django CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ==========================================
  # 1부: 코드 품질 및 빌드 테스트 (CI)
  # ==========================================
  linting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
      - name: Run Flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,migrations

  formatting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Black
        run: pip install black
      - name: Check Formatting
        run: black . --check --exclude=venv/

  import-sorting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install isort
        run: pip install isort
      - name: Check Import Sorting
        run: isort . --check-only --profile black --skip venv/

  security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Safety
        run: pip install safety
      - name: Run Security Check
        run: safety check -r requirements.txt --continue-on-error

  docker-build-test:
    runs-on: ubuntu-latest
    needs: [linting, formatting, security-check]
    steps:
      - uses: actions/checkout@v3
      # 테스트용 더미 환경변수 생성 (빌드 테스트 통과용)
      - name: Create dummy .env.prod for test
        run: |
          echo "DEBUG=False" >> .env.prod
          echo "SECRET_KEY=test_key" >> .env.prod
          echo "ALLOWED_HOSTS=localhost" >> .env.prod
          echo "POSTGRES_DB=test_db" >> .env.prod
          echo "POSTGRES_USER=test_user" >> .env.prod
          echo "POSTGRES_PASSWORD=test_pw" >> .env.prod
          echo "POSTGRES_HOST=db" >> .env.prod
          echo "POSTGRES_PORT=5432" >> .env.prod
          echo "DJANGO_EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend" >> .env.prod

      - name: Build Docker Compose
        run: docker compose config && docker compose build

      - name: Run Containers
        run: docker compose up -d

      - name: Check Container Status
        run: |
          sleep 10
          docker compose ps
          if [ $(docker compose ps | grep "Up" | wc -l) -ge 3 ]; then
            echo "All containers running!"
          else
            docker compose logs
            exit 1
          fi

  # ==========================================
  # [추가됨] 2부: 실제 배포용 이미지 빌드 및 푸시 (CD 준비)
  # ==========================================
  build-and-push-image:
    runs-on: ubuntu-latest
    needs: [docker-build-test] # 테스트 통과 후 실행
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          # [중요] GCP VM 아키텍처(AMD64)에 맞춰 빌드
          platforms: linux/amd64
          push: true
          tags: heksis/oss-django:latest

  # ==========================================
  # 3부: 서버 자동 배포 (CD 실행)
  # ==========================================
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-push-image] # 이미지가 올라간 후 실행되어야 함
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: 22
          script: |
            # 1. 프로젝트 폴더로 이동
            cd OpenSourceSW_team_5

            export KUBECONFIG=~/.kube/config

            # 2. 최신 코드 받기 (K8s YAML 파일 갱신용)
            git fetch
            git reset --hard origin/main

            # 3. Docker Hub 로그인 (이미지 pull 권한 갱신)
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # 4. Secret 갱신 (비밀번호 변경 시 자동 반영)
            kubectl delete secret django-secret --ignore-not-found --kubeconfig ~/.kube/config

            kubectl create secret generic django-secret \
              --from-literal=SECRET_KEY='${{ secrets.SECRET_KEY }}' \
              --from-literal=POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}' \
              --from-literal=EMAIL_HOST_PASSWORD='${{ secrets.EMAIL_HOST_PASSWORD }}' \
              --kubeconfig ~/.kube/config

            # 5. K8s 설정 적용 (Deployment, Service 등)
            kubectl apply -f k8s/ --kubeconfig ~/.kube/config

            # 6. [중요] 새 이미지를 가져오기 위해 강제 재시작 (Rollout Restart)
            kubectl rollout restart deployment django-deployment --kubeconfig ~/.kube/config

            # 7. 배포 상태 확인
            echo "Deployment triggered!"
            kubectl get pods --kubeconfig ~/.kube/config
